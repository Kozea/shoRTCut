// Generated by CoffeeScript 1.6.3
(function() {
  var LocalBinaryChannel, LocalTextChannel, RTCTest, RemoteBinaryChannel, RemoteTextChannel, bytes, chat, chat_send, file_receiver, file_send, files, make_progress,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  chat = function(text, type) {
    var $sb;
    if (type == null) {
      type = 'text';
    }
    $sb = $('.scrollback');
    $sb.append($('<div>')[type](text));
    return $sb.stop(true, true).animate({
      scrollTop: $sb.prop('scrollHeight') - $sb.height()
    });
  };

  chat_send = null;

  file_send = null;

  file_receiver = null;

  files = [];

  bytes = function(size) {
    var byteUnits, i;
    i = -1;
    byteUnits = [" kB", " MB", " GB", " TB", "PB", "EB", "ZB", "YB"];
    while (true) {
      size /= 1000;
      i++;
      if (!(size > 1000)) {
        break;
      }
    }
    return Math.max(size, 0.1).toFixed(1) + byteUnits[i];
  };

  make_progress = function(text, max) {
    var $progress;
    $('.progresses').append($('<tr>').append($('<td>').text(text), $('<td>').append($progress = $('<progress>', {
      max: max
    }))));
    return $progress;
  };

  RemoteTextChannel = (function(_super) {
    __extends(RemoteTextChannel, _super);

    function RemoteTextChannel() {
      RemoteTextChannel.__super__.constructor.apply(this, arguments);
      chat_send = this.send.bind(this);
    }

    RemoteTextChannel.prototype.open = function() {
      RemoteTextChannel.__super__.open.apply(this, arguments);
      return chat('Chat Connected');
    };

    RemoteTextChannel.prototype.close = function() {
      RemoteTextChannel.__super__.close.apply(this, arguments);
      return chat('Chat Connection closed.');
    };

    return RemoteTextChannel;

  })(ShoRTCut.prototype.TextChannel);

  LocalTextChannel = (function(_super) {
    __extends(LocalTextChannel, _super);

    function LocalTextChannel() {
      LocalTextChannel.__super__.constructor.apply(this, arguments);
    }

    LocalTextChannel.prototype.open = function() {
      LocalTextChannel.__super__.open.apply(this, arguments);
      return $('input[name=local]').attr('disabled', null).on('keyup', function(e) {
        if (e.keyCode === 13 && $(this).val()) {
          chat_send('CHAT', $(this).val());
          chat('me   < ' + $(this).val());
          return $(this).val('');
        }
      });
    };

    LocalTextChannel.prototype.CHAT = function(message) {
      return chat('peer > ' + message);
    };

    LocalTextChannel.prototype.ACK = function() {
      var file;
      if (!files.length) {
        return;
      }
      file = files[0];
      return chat_send("FILE|" + file.size + "," + file.type + "," + file.name);
    };

    LocalTextChannel.prototype.ACCEPT = function() {
      var $progress, file;
      if (!files.length) {
        return;
      }
      file = files.shift();
      $progress = make_progress("Sending " + file.name, 100);
      return new ShoRTCutHelpers.prototype.FileSender(file, file_send, (function() {
        return chat("File sent.");
      }), (function(p) {
        return $progress.val(p);
      }));
    };

    LocalTextChannel.prototype.FILE = function(message) {
      var $progress, FileReceiver, args, name, size, type;
      args = message.split(',');
      size = +args.shift();
      type = args.shift();
      name = args.join(',');
      $progress = make_progress("Receiving " + name, size);
      FileReceiver = ShoRTCutHelpers.prototype.getFileReceiver();
      return file_receiver = new FileReceiver(name, size, type, function() {
        chat("Receiving file " + name + " " + (bytes(size)));
        return chat_send("ACCEPT");
      }, function() {
        chat("peer > File: <a href=\"" + (file_receiver.url()) + "\" download=\"" + file_receiver.name + "\">" + file_receiver.name + "</a>", 'html');
        chat_send('CHAT', "File received ! (received " + (bytes(file_receiver.size)) + ")");
        file_receiver = null;
        return chat_send('ACK');
      }, function(p) {
        return $progress.val(p);
      });
    };

    LocalTextChannel.prototype.close = function() {
      LocalTextChannel.__super__.close.apply(this, arguments);
      return $('input[name=local]').attr('disabled', 'disabled').off('keyup');
    };

    return LocalTextChannel;

  })(ShoRTCut.prototype.TextChannel);

  RemoteBinaryChannel = (function(_super) {
    __extends(RemoteBinaryChannel, _super);

    function RemoteBinaryChannel() {
      RemoteBinaryChannel.__super__.constructor.apply(this, arguments);
      file_send = this.send.bind(this);
    }

    RemoteBinaryChannel.prototype.open = function() {
      RemoteBinaryChannel.__super__.open.apply(this, arguments);
      return chat('File Connected');
    };

    RemoteBinaryChannel.prototype.close = function() {
      RemoteBinaryChannel.__super__.close.apply(this, arguments);
      return chat('File Connection closed.');
    };

    return RemoteBinaryChannel;

  })(ShoRTCut.prototype.BinaryChannel);

  LocalBinaryChannel = (function(_super) {
    __extends(LocalBinaryChannel, _super);

    function LocalBinaryChannel() {
      LocalBinaryChannel.__super__.constructor.apply(this, arguments);
    }

    LocalBinaryChannel.prototype.open = function() {
      var _this = this;
      LocalBinaryChannel.__super__.open.apply(this, arguments);
      return $('.filedrop').addClass('active').on('dragover', function(e) {
        $(this).addClass('hover');
        e = e.originalEvent;
        e.stopPropagation();
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        return false;
      }).on('dragleave', function(e) {
        return $(this).removeClass('hover');
      }).on('drop', function(e) {
        var file, _i, _len, _ref;
        if (!$('.filedrop').hasClass('active')) {
          return;
        }
        $('.filedrop').removeClass('hover').removeClass('active');
        setTimeout(function() {
          return $('.filedrop').addClass('active');
        }, 500);
        e = e.originalEvent;
        e.stopPropagation();
        e.preventDefault();
        _ref = e.dataTransfer.files;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          file = _ref[_i];
          if (__indexOf.call(files, file) < 0) {
            files.push(file);
          }
        }
        if (files.length) {
          file = files[0];
          chat_send("FILE|" + file.size + "," + file.type + "," + file.name);
        }
        return false;
      });
    };

    LocalBinaryChannel.prototype.binary = function(part) {
      return file_receiver != null ? file_receiver.add(part) : void 0;
    };

    LocalBinaryChannel.prototype.close = function() {
      LocalBinaryChannel.__super__.close.apply(this, arguments);
      return $('.filedrop').removeClass('active').off('dragover').off('dragleave').off('drop');
    };

    return LocalBinaryChannel;

  })(ShoRTCut.prototype.BinaryChannel);

  RTCTest = (function(_super) {
    __extends(RTCTest, _super);

    function RTCTest() {
      RTCTest.__super__.constructor.apply(this, arguments);
      this.LocalTextChannel = LocalTextChannel;
      this.RemoteTextChannel = RemoteTextChannel;
      this.LocalBinaryChannel = LocalBinaryChannel;
      this.RemoteBinaryChannel = RemoteBinaryChannel;
    }

    RTCTest.prototype.assign_local_stream_url = function(url) {
      chat('Local video connected');
      return $('video.local').attr('src', url);
    };

    RTCTest.prototype.assign_remote_stream_url = function(url) {
      chat('Remote video connected');
      return $('video.remote').attr('src', url);
    };

    RTCTest.prototype.reset = function() {
      RTCTest.__super__.reset.apply(this, arguments);
      chat('--');
      chat('Reset');
      return chat('--');
    };

    RTCTest.prototype.caller = function() {
      return $('h1').text('shoRTCut - caller');
    };

    RTCTest.prototype.callee = function() {
      return $('h1').text('shoRTCut - callee');
    };

    return RTCTest;

  })(ShoRTCut);

  $(function() {
    var rtctest;
    rtctest = new RTCTest();
    rtctest.start();
    chat('Connecting...');
    return window.rtc = rtctest;
  });

}).call(this);
